{% extends "base.html" %}

{% block title %}Movie Recommendations - Plex Movie Selector{% endblock %}

{% block content %}
<div class="recommendation-container">
    <div class="filters-section">
        <h2>Filter Options</h2>
        <form id="filters-form">
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="exclude_watched" checked>
                    Exclude Watched Movies
                </label>
            </div>

            <div class="filter-group">
                <label>
                    <input type="checkbox" id="exclude_same_actors">
                    Exclude Movies with Same Actors as Last Watched
                </label>
            </div>

            <div class="filter-group">
                <label>
                    <input type="checkbox" id="exclude_same_director">
                    Exclude Movies from Same Director as Last Watched
                </label>
            </div>

            <div class="filter-group">
                <label for="filter_decade">Filter by Decade</label>
                <select id="filter_decade">
                    <option value="">All Decades</option>
                    <option value="1950s">1950s</option>
                    <option value="1960s">1960s</option>
                    <option value="1970s">1970s</option>
                    <option value="1980s">1980s</option>
                    <option value="1990s">1990s</option>
                    <option value="2000s">2000s</option>
                    <option value="2010s">2010s</option>
                    <option value="2020s">2020s</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter_actor">Filter by Actor</label>
                <input type="text" id="filter_actor" placeholder="Enter actor name">
            </div>

            <button type="button" id="apply-filters-btn" class="btn btn-secondary">Apply Filters</button>
        </form>
    </div>

    <div class="recommendation-section">
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Finding your perfect movie...</p>
        </div>

        <div id="no-recommendation" class="no-recommendation" style="display: none;">
            <h2>No Movies Available</h2>
            <p id="no-recommendation-message">Click "Get Recommendation" to find a movie</p>
        </div>

        <div id="movie-card" class="movie-card" style="display: none;">
            <div class="movie-poster">
                <img id="movie-poster-img" src="" alt="Movie Poster">
            </div>
            <div class="movie-details">
                <h2 id="movie-title"></h2>
                <div class="movie-meta">
                    <span id="movie-year"></span>
                    <span class="separator">•</span>
                    <span id="movie-rating" class="rating"></span>
                </div>
                <p id="movie-summary" class="movie-summary"></p>
                <div class="movie-credits">
                    <p><strong>Director:</strong> <span id="movie-directors"></span></p>
                    <p><strong>Cast:</strong> <span id="movie-actors"></span></p>
                </div>
                <div class="movie-actions">
                    <button id="play-btn" class="btn btn-primary">Play Movie</button>
                    <button id="pass-btn" class="btn btn-secondary">Pass</button>
                    <button id="next-btn" class="btn btn-secondary">Get Another Recommendation</button>
                </div>
            </div>
        </div>

        <div id="initial-state" class="initial-state">
            <h2>Ready to Find Your Next Movie?</h2>
            <p>Configure your filters and get a personalized recommendation</p>
            <button id="get-recommendation-btn" class="btn btn-primary btn-large">Get Recommendation</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMovie = null;

// Load preferences on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadPreferences();
});

async function loadPreferences() {
    try {
        const response = await fetch('/api/preferences');
        const data = await response.json();

        if (data.success) {
            const prefs = data.preferences;
            document.getElementById('exclude_watched').checked = prefs.exclude_watched;
            document.getElementById('exclude_same_actors').checked = prefs.exclude_same_actors;
            document.getElementById('exclude_same_director').checked = prefs.exclude_same_director;
            document.getElementById('filter_decade').value = prefs.filter_decade || '';
            document.getElementById('filter_actor').value = prefs.filter_actor || '';
        }
    } catch (error) {
        console.error('Error loading preferences:', error);
    }
}

async function savePreferences() {
    const preferences = {
        exclude_watched: document.getElementById('exclude_watched').checked,
        exclude_same_actors: document.getElementById('exclude_same_actors').checked,
        exclude_same_director: document.getElementById('exclude_same_director').checked,
        filter_decade: document.getElementById('filter_decade').value,
        filter_actor: document.getElementById('filter_actor').value
    };

    try {
        await fetch('/api/preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        });
    } catch (error) {
        console.error('Error saving preferences:', error);
    }
}

async function getRecommendation() {
    showLoading();

    try {
        const response = await fetch('/api/recommend');
        const data = await response.json();

        if (response.ok && data.success) {
            currentMovie = data.movie;
            displayMovie(data.movie);
        } else {
            showNoRecommendation(data.error || 'No movies found matching your criteria');
        }
    } catch (error) {
        showNoRecommendation('An error occurred. Please try again.');
    }
}

function displayMovie(movie) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('no-recommendation').style.display = 'none';
    document.getElementById('initial-state').style.display = 'none';
    document.getElementById('movie-card').style.display = 'flex';

    document.getElementById('movie-title').textContent = movie.title;
    document.getElementById('movie-year').textContent = movie.year || 'Unknown';
    document.getElementById('movie-rating').textContent = `⭐ ${movie.rating.toFixed(1)}/10`;
    document.getElementById('movie-summary').textContent = movie.summary || 'No summary available';
    document.getElementById('movie-directors').textContent = movie.directors.join(', ') || 'Unknown';
    document.getElementById('movie-actors').textContent = movie.actors.join(', ') || 'Unknown';

    // Set poster if available
    if (movie.poster) {
        document.getElementById('movie-poster-img').src = movie.poster;
    }
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('no-recommendation').style.display = 'none';
    document.getElementById('initial-state').style.display = 'none';
    document.getElementById('movie-card').style.display = 'none';
}

function showNoRecommendation(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('no-recommendation').style.display = 'block';
    document.getElementById('no-recommendation-message').textContent = message;
    document.getElementById('initial-state').style.display = 'none';
    document.getElementById('movie-card').style.display = 'none';
}

async function playMovie() {
    if (!currentMovie) return;

    try {
        const response = await fetch('/api/play', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rating_key: currentMovie.rating_key })
        });

        const data = await response.json();

        if (data.success) {
            alert('Movie is now playing on your Plex client!');
        } else {
            alert('Failed to play movie: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
}

async function passMovie() {
    if (!currentMovie) return;

    try {
        const response = await fetch('/api/pass', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                rating_key: currentMovie.rating_key,
                title: currentMovie.title
            })
        });

        const data = await response.json();

        if (data.success) {
            // Get next recommendation
            getRecommendation();
        } else {
            alert('Failed to pass movie: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
}

// Event listeners
document.getElementById('apply-filters-btn').addEventListener('click', async () => {
    await savePreferences();
    alert('Filters applied! Get a new recommendation to see the results.');
});

document.getElementById('get-recommendation-btn').addEventListener('click', getRecommendation);
document.getElementById('next-btn').addEventListener('click', getRecommendation);
document.getElementById('play-btn').addEventListener('click', playMovie);
document.getElementById('pass-btn').addEventListener('click', passMovie);
</script>
{% endblock %}
